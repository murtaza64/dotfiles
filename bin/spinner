#!/usr/bin/env python3
import sys
import subprocess
import threading
import time
import signal
import argparse

class Spinner:
    def __init__(self, title="Loading", color="white"):
        self.title = title
        self.frames = ["⠋", "⠙", "⠹", "⠸", "⠼", "⠴", "⠦", "⠧", "⠇", "⠏"]
        self.running = False
        self.frame_index = 0
        self.color_code = self._get_color_code(color)

    def _get_color_code(self, color):
        colors = {
            "black": "\033[30m",
            "red": "\033[31m",
            "green": "\033[32m",
            "yellow": "\033[33m",
            "blue": "\033[34m",
            "magenta": "\033[35m",
            "cyan": "\033[36m",
            "white": "\033[37m",
            "bright_black": "\033[90m",
            "bright_red": "\033[91m",
            "bright_green": "\033[92m",
            "bright_yellow": "\033[93m",
            "bright_blue": "\033[94m",
            "bright_magenta": "\033[95m",
            "bright_cyan": "\033[96m",
            "bright_white": "\033[97m"
        }
        return colors.get(color.lower(), colors["white"])

    def start(self):
        self.running = True
        self.spinner_thread = threading.Thread(target=self._spin)
        self.spinner_thread.daemon = True
        self.spinner_thread.start()

    def stop(self):
        self.running = False
        if hasattr(self, 'spinner_thread'):
            self.spinner_thread.join()
        # Clear the spinner line
        sys.stderr.write('\r' + ' ' * (len(self.title) + 10) + '\r')
        sys.stderr.flush()

    def _spin(self):
        reset_code = "\033[0m"
        while self.running:
            frame = self.frames[self.frame_index % len(self.frames)]
            spinner_text = f"\r{self.color_code}{frame} {self.title}...{reset_code}"
            sys.stderr.write(spinner_text)
            sys.stderr.flush()
            self.frame_index += 1
            time.sleep(0.08)

def run_with_spinner(command, title="Loading", color="white"):
    spinner = Spinner(title, color)

    # Handle Ctrl+C gracefully
    def signal_handler(signum, frame):
        spinner.stop()
        sys.exit(1)

    signal.signal(signal.SIGINT, signal_handler)

    try:
        spinner.start()

        # Run the command and capture output
        process = subprocess.Popen(
            command,
            shell=True,
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True
        )

        # Forward stdin if available (non-blocking check)
        stdin_data = None
        if not sys.stdin.isatty():
            # If there's data piped to stdin, read it
            stdin_data = sys.stdin.read()

        stdout, stderr = process.communicate(input=stdin_data)

        spinner.stop()

        # Print stderr immediately (errors)
        if stderr:
            sys.stderr.write(stderr)
            sys.stderr.flush()

        # Print stdout (main output)
        if stdout:
            sys.stdout.write(stdout)
            sys.stdout.flush()

        return process.returncode

    except Exception as e:
        spinner.stop()
        sys.stderr.write(f"Error: {e}\n")
        return 1

def main():
    parser = argparse.ArgumentParser(description="Run a command with a spinner")
    parser.add_argument("--title", default="Loading", help="Spinner title text")
    parser.add_argument("--color", default="white",
                       choices=["black", "red", "green", "yellow", "blue", "magenta",
                               "cyan", "white", "bright_black", "bright_red", "bright_green",
                               "bright_yellow", "bright_blue", "bright_magenta",
                               "bright_cyan", "bright_white"],
                       help="Spinner color")
    parser.add_argument("command", nargs=argparse.REMAINDER, help="Command to run")

    args = parser.parse_args()

    if not args.command:
        parser.error("No command provided")

    command = " ".join(args.command)
    return run_with_spinner(command, args.title, args.color)

if __name__ == "__main__":
    sys.exit(main())