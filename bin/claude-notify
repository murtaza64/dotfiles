#!/usr/bin/env python3
"""
Claude Code notification hook - stores notifications and sends system alerts.
Called by Claude on idle_prompt and permission_prompt events. Receives JSON on stdin.
"""

import json
import os
import subprocess as sp
import sys
from datetime import datetime
from pathlib import Path
from uuid import uuid4

NOTIFICATIONS_FILE = Path.home() / '.cache' / 'claude-notifications.json'


def get_tmux_target():
    """Find the tmux session:window.pane for the current process."""
    try:
        # Get all panes with their PIDs
        result = sp.run(
            ['tmux', 'list-panes', '-a', '-F', '#{pane_pid}:#{session_name}:#{window_index}:#{pane_index}'],
            capture_output=True, text=True
        )
        if result.returncode != 0:
            return None

        # Walk up process tree to find a matching pane PID
        pid = os.getpid()
        pane_map = {}
        for line in result.stdout.strip().split('\n'):
            if not line:
                continue
            parts = line.split(':')
            if len(parts) == 4:
                pane_pid, session, window, pane = parts
                pane_map[int(pane_pid)] = f"{session}:{window}.{pane}"

        # Walk up the process tree
        while pid > 1:
            if pid in pane_map:
                return pane_map[pid]
            # Get parent PID
            try:
                with open(f'/proc/{pid}/stat', 'r') as f:
                    ppid = int(f.read().split()[3])
            except (FileNotFoundError, IOError):
                # macOS fallback
                result = sp.run(['ps', '-o', 'ppid=', '-p', str(pid)], capture_output=True, text=True)
                if result.returncode != 0:
                    break
                ppid = int(result.stdout.strip())
            pid = ppid

        return None
    except Exception:
        return None


def read_notifications():
    """Read existing notifications from file."""
    if NOTIFICATIONS_FILE.exists():
        try:
            return json.loads(NOTIFICATIONS_FILE.read_text())
        except (json.JSONDecodeError, IOError):
            return []
    return []


def write_notifications(notifications):
    """Write notifications to file."""
    NOTIFICATIONS_FILE.parent.mkdir(parents=True, exist_ok=True)
    NOTIFICATIONS_FILE.write_text(json.dumps(notifications, indent=2))


def main():
    # Read hook data from stdin
    try:
        hook_data = json.load(sys.stdin)
    except json.JSONDecodeError:
        hook_data = {}

    # Determine notification type
    notification_type = hook_data.get('notification_type', 'idle_prompt')
    is_permission = notification_type == 'permission_prompt'

    # Extract message
    message = hook_data.get('message', 'Waiting for your input')
    # Truncate for preview
    message_preview = message[:100] + '...' if len(message) > 100 else message
    message_preview = message_preview.replace('\n', ' ')

    # Get current working directory (prefer from hook data)
    cwd = hook_data.get('cwd', os.getcwd())
    cwd_display = cwd.replace(str(Path.home()), '~')

    # Get tmux target (allow override via env for testing)
    tmux_target = os.environ.get('CLAUDE_NOTIFY_TARGET') or get_tmux_target()

    # Create notification
    notification = {
        'id': str(uuid4()),
        'type': notification_type,
        'cwd': cwd,
        'message': message_preview,
        'timestamp': datetime.now().isoformat(),
        'tmux_target': tmux_target
    }

    # Append to notifications file, removing older notifications for same tmux target
    notifications = read_notifications()
    if tmux_target:
        notifications = [n for n in notifications if n.get('tmux_target') != tmux_target]
    notifications.append(notification)
    write_notifications(notifications)

    # Send system notification with different styling
    cwd_short = Path(cwd).name
    if is_permission:
        title = f'Claude - {cwd_short} - Permission'
        sound = 'Purr'
    else:
        title = f'Claude - {cwd_short} - Idle'
        sound = 'Glass'

    body = message_preview[:80]
    sp.run([
        'terminal-notifier',
        '-title', title,
        '-message', body,
        '-sound', sound
    ], capture_output=True)


if __name__ == '__main__':
    main()
