#!/bin/bash
set -e

# Simple audio recording and transcription script
# Records until user stops with Ctrl+C

TEMP_DIR=$(mktemp -d)
AUDIO_FILE="$TEMP_DIR/recording.wav"
OUTPUT_FILE="$TEMP_DIR/output"
WHISPER_MODEL="$HOME/whisper.cpp/models/ggml-large-v3-turbo.bin"
WHISPER_CLI="$HOME/whisper.cpp/build/bin/whisper-cli"

echo "Recording... Press Enter or Ctrl+D to stop and transcribe." >&2

# Start sox in background
sox -t coreaudio "MacBook Pro Microphone" "$AUDIO_FILE" &
SOX_PID=$!

# Wait for user input (Enter or Ctrl+D)
read -r

# Kill sox
kill -INT $SOX_PID 2>/dev/null
wait $SOX_PID 2>/dev/null

echo "Recording stopped. Transcribing..." >&2

# Transcribe using whisper.cpp
"$WHISPER_CLI" "$AUDIO_FILE" -m "$WHISPER_MODEL" -otxt -of "$OUTPUT_FILE" -np 1>&2

# Print transcription to stdout
if [ -f "$OUTPUT_FILE.txt" ]; then
    sed 's/^[[:space:]]*//;s/[[:space:]]*$//' "$OUTPUT_FILE.txt"
else
    echo "Error: Transcription failed" >&2
    exit 1
fi
