#!/bin/bash
set -e

# Simple audio recording and transcription script
# Records until user stops with Ctrl+C

TEMP_DIR=/tmp/transcribe_$(date +%Y-%m-%d_%H-%M-%S)
mkdir -p "$TEMP_DIR"
AUDIO_FILE="$TEMP_DIR/recording.wav"
OUTPUT_FILE="$TEMP_DIR/output"
WHISPER_MODEL="$HOME/whisper.cpp/models/ggml-large-v3-turbo.bin"
WHISPER_CLI="$HOME/whisper.cpp/build/bin/whisper-cli"

echo "Recording to $TEMP_DIR..." >&2
echo "Press any key to end recording, Escape/^C to cancel." >&2

# Start sox in background
sox -t coreaudio "MacBook Pro Microphone" "$AUDIO_FILE" &
SOX_PID=$!

# Wait for single character input
read -n 1 -r INPUT

# Kill sox
kill -INT $SOX_PID 2>/dev/null
wait $SOX_PID 2>/dev/null

# Check if user pressed escape to cancel
if [ "$INPUT" = $'\e' ] || [ "$INPUT" = $'\033' ]; then
    echo -e "\nRecording cancelled." >&2
    exit 0
fi

echo "Recording stopped. Transcribing..." >&2

# Transcribe using whisper.cpp
"$WHISPER_CLI" "$AUDIO_FILE" -m "$WHISPER_MODEL" -otxt -of "$OUTPUT_FILE" -np 1>&2

# Print transcription to stdout
if [ -f "$OUTPUT_FILE.txt" ]; then
    sed 's/^[[:space:]]*//;s/[[:space:]]*$//' "$OUTPUT_FILE.txt"
else
    echo "Error: Transcription failed" >&2
    exit 1
fi
