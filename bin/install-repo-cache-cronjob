#!/usr/bin/env bash

# Install a cronjob to update repo cache every 6 hours

SCRIPT_PATH="$HOME/dotfiles/bin/update-repo-cache"

# Check if script exists
if [[ ! -f "$SCRIPT_PATH" ]]; then
    echo "Error: $SCRIPT_PATH not found" >&2
    exit 1
fi

# Cronjob: Run every 6 hours at :15 minutes past the hour (0:15, 6:15, 12:15, 18:15)
CRON_LINE="15 */6 * * * $SCRIPT_PATH > /dev/null 2>&1"

# Check if cronjob already exists
if crontab -l 2>/dev/null | grep -F "$SCRIPT_PATH" > /dev/null; then
    echo "Cronjob already exists:"
    crontab -l | grep -F "$SCRIPT_PATH"
    echo ""
    read -p "Replace it? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled"
        exit 0
    fi
    
    # Remove existing cronjob
    crontab -l | grep -v -F "$SCRIPT_PATH" | crontab -
fi

# Add new cronjob
(crontab -l 2>/dev/null; echo "$CRON_LINE") | crontab -

echo "âœ“ Cronjob installed successfully!"
echo ""
echo "Schedule: Every 6 hours (at :15 past the hour)"
echo "Script: $SCRIPT_PATH"
echo "Log: ~/.cache/repos/.update-log"
echo ""
echo "To view current cronjobs: crontab -l"
echo "To remove this cronjob: crontab -e (then delete the line)"
echo ""
echo "Run manually now? (y/n)"
read -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "Running update-repo-cache..."
    "$SCRIPT_PATH"
fi
