#!/usr/bin/env bash

# get dirs and sessions
tmp=$(mktemp)
fd . ~ --max-depth=1 --type d > $tmp
sessions=$(tmux list-sessions -F "#{session_name}")
# remove dirs that already have a matching session
for session in $sessions; do
    sed -e "\\#/$session/\$#d" -i '' "$tmp"
done
# filter out dirs without git repos
# for dir in $dirs; do
#     if [ ! -d "$dir/.git" ]; then
#         sed "\\_/$dir\$_d" -i'' $tmp
#     fi
# done
while read -r line; do
    if [ ! -d "$line/.git" ]; then
        sed -e "\#$line#d" -i '' $tmp
    fi
done < tmp
# split sessions into lines
selected=$( (echo $sessions | tr ' ' '\n'; cat $tmp) | fzf )

# if selected is a session, switch to it
if echo $sessions | tr ' ' '\n' | grep -q "^$selected$"; then
    tmux switch-client -t $selected
    exit 0
fi
# create a new session
if [ ! -d "$selected" ]; then
    echo "No such directory: $selected"
    exit 1
fi
selected=${selected%/}
selected_name=$(basename "$selected" | tr . _)
tmux new-session -ds $selected_name -c $selected
tmux switch-client -t $selected_name
